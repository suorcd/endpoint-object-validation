---
# Tailscale Operator ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: tailscale-operator
  namespace: default

---
# Tailscale Operator ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: tailscale-operator
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
- apiGroups: [""]
  resources: ["services"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["events"]
  verbs: ["get", "create", "patch"]

---
# Tailscale Operator ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: tailscale-operator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: tailscale-operator
subjects:
- kind: ServiceAccount
  name: tailscale-operator
  namespace: default

---
# NOTE: Tailscale Auth Secret is created by tailscale-setup.sh
# Do not define it here to avoid overwriting the auth key

---
# Tailscale Proxy Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: eov-flask-tailscale
  labels:
    app: eov-flask-tailscale
spec:
  replicas: 1
  selector:
    matchLabels:
      app: eov-flask-tailscale
  template:
    metadata:
      labels:
        app: eov-flask-tailscale
    spec:
      serviceAccountName: tailscale-operator
      containers:
      # nginx proxy sidecar to forward localhost requests to the k8s service
      - name: nginx-proxy
        image: nginx:alpine
        ports:
        - containerPort: 80
          name: http
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/conf.d
        resources:
          requests:
            memory: "16Mi"
            cpu: "25m"
          limits:
            memory: "64Mi"
            cpu: "100m"
      
      - name: tailscale
        image: tailscale/tailscale:latest
        imagePullPolicy: IfNotPresent
        
        env:
        - name: TS_AUTHKEY
          valueFrom:
            secretKeyRef:
              name: tailscale-auth
              key: auth-key
        - name: TS_HOSTNAME
          value: "eov-flask"
        - name: TS_ACCEPT_DNS
          value: "true"
        - name: TS_ROUTES
          value: ""
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_UID
          valueFrom:
            fieldRef:
              fieldPath: metadata.uid
        
        ports:
        - containerPort: 8443
          name: https
        
        resources:
          requests:
            memory: "32Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "200m"
        
        securityContext:
          privileged: true
          runAsUser: 0
        
        volumeMounts:
        - name: state
          mountPath: /var/lib/tailscale
        - name: config
          mountPath: /config
      
      volumes:
      - name: state
        emptyDir: {}
      - name: nginx-config
        configMap:
          name: nginx-proxy-config
      - name: config
        configMap:
          name: tailscale-serve-config
          optional: true

---
# Tailscale Serve Configuration ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-proxy-config
  namespace: default
data:
  default.conf: |
    server {
        listen 80;
        server_name _;
        
        location / {
            proxy_pass http://eov-flask-service.default.svc.cluster.local:80;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

---
# Tailscale Serve Configuration ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: tailscale-serve-config
  namespace: default
data:
  serve.json: |
    {
      "TCP": {
        "80": {
          "HTTP": true
        }
      },
      "Web": {
        "${TS_CERT_DOMAIN}:80": {
          "Handlers": {
            "/": {
              "Proxy": "http://eov-flask-service.default.svc.cluster.local:80"
            }
          }
        }
      }
    }

---
# Service for Tailscale proxy
apiVersion: v1
kind: Service
metadata:
  name: eov-flask-tailscale-service
  namespace: default
spec:
  selector:
    app: eov-flask-tailscale
  ports:
  - port: 443
    targetPort: 8443
    protocol: TCP
    name: https
  type: ClusterIP

---
# Tailscale Operator ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: tailscale-operator
  namespace: eov

---
# Tailscale Operator ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: tailscale-operator
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
- apiGroups: [""]
  resources: ["services"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["events"]
  verbs: ["get", "create", "patch"]

---
# Tailscale Operator ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: tailscale-operator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: tailscale-operator
subjects:
- kind: ServiceAccount
  name: tailscale-operator
  namespace: eov

---
# NOTE: Tailscale Auth Secret is created by tailscale-setup.sh
# Do not define it here to avoid overwriting the auth key

---
# EOV Flask Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: eov-flask
  namespace: eov
  labels:
    app: eov-flask
spec:
  replicas: 1
  selector:
    matchLabels:
      app: eov-flask
  template:
    metadata:
      labels:
        app: eov-flask
    spec:
      containers:
      - name: eov-flask
        image: ${IMAGE_NAME}
        imagePullPolicy: Always
        ports:
        - containerPort: 5000
          name: http
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "500m"

---
# Service for EOV Flask
apiVersion: v1
kind: Service
metadata:
  name: eov-flask-service
  namespace: eov
spec:
  selector:
    app: eov-flask
  ports:
  - port: 80
    targetPort: 5000
    protocol: TCP
    name: http
  type: ClusterIP

---
# Tailscale Proxy Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: eov-flask-tailscale
  labels:
    app: eov-flask-tailscale
spec:
  replicas: 1
  selector:
    matchLabels:
      app: eov-flask-tailscale
  template:
    metadata:
      labels:
        app: eov-flask-tailscale
    spec:
      serviceAccountName: tailscale-operator
      containers:
      # Removed nginx-proxy to avoid port 80 conflict; Tailscale now handles port 80 directly.
      - name: tailscale
        image: tailscale/tailscale:latest
        imagePullPolicy: IfNotPresent
        
        env:
        - name: TS_AUTHKEY
          valueFrom:
            secretKeyRef:
              name: tailscale-auth
              key: auth-key
        - name: TS_HOSTNAME
          value: "eov-flask"
        - name: TS_ACCEPT_DNS
          value: "true"
        - name: TS_ROUTES
          value: ""
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_UID
          valueFrom:
            fieldRef:
              fieldPath: metadata.uid
        - name: TS_SERVE_CONFIG
          value: "/config/serve.json"
        
        ports:
        - containerPort: 80
          name: http
        - containerPort: 443
          name: https
        
        resources:
          requests:
            memory: "32Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "200m"
        
        securityContext:
          privileged: true
          runAsUser: 0
        
        volumeMounts:
        - name: state
          mountPath: /var/lib/tailscale
        - name: config
          mountPath: /config
      
      volumes:
      - name: state
        emptyDir: {}
      - name: config
        configMap:
          name: tailscale-serve-config
          optional: true

---
# Tailscale Serve Configuration ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: tailscale-serve-config
  namespace: eov
data:
  # The PLACEHOLDER string below will be replaced by tailscale-setup.sh
  serve.json: |
    {
      "TCP": {
        "80": {
          "HTTP": true
        },
        "443": {
          "HTTPS": true
        }
      },
      "Web": {
        "eov-flask.PLACEHOLDER_TAILNET_NAME:80": {
          "Handlers": {
            "/": {
              "Proxy": "http://eov-flask-service.eov.svc.cluster.local:80"
            }
          }
        },
        "eov-flask.PLACEHOLDER_TAILNET_NAME:443": {
          "Handlers": {
            "/": {
              "Proxy": "http://eov-flask-service.eov.svc.cluster.local:80"
            }
          }
        }
      }
    }

---
# Service for Tailscale proxy
apiVersion: v1
kind: Service
metadata:
  name: eov-flask-tailscale-service
  namespace: eov
spec:
  selector:
    app: eov-flask-tailscale
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
    name: http
  - port: 443
    targetPort: 443
    protocol: TCP
    name: https
  type: ClusterIP